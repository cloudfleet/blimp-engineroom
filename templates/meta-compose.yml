---
version: '3'

services:
  mastodonpostgres:
    restart: always
    image: postgres:9.6-alpine
    networks:
      - mastodon
    volumes:
      - /opt/cloudfleet/data/apps/mastodon/postgres:/var/lib/postgresql/data

  mastodonredis:
    restart: always
    image: redis:4.0-alpine
    networks:
      - mastodon
    volumes:
      - /opt/cloudfleet/data/apps/mastodon/redis:/data

  mastodonelastic:
    restart: always
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:6.1.3
    environment:
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    networks:
      - mastodon
    volumes:
      - /opt/cloudfleet/data/apps/mastodon/es:/usr/share/elasticsearch/data

  web:
    image: cloudfleet/blimp-mastodon
    restart: always
    command: bash -c "rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000 -b '0.0.0.0'"
    networks:
      - external_network
      - internal_network
    depends_on:
      - mastodonpostgres
      - mastodonredis
      - mastodonelastic
    volumes:
      - /opt/cloudfleet/data/apps/mastodon/mastodon:/mastodon/public/system
    environment:
      LOCAL_DOMAIN: {{'myblimp.net' | env('CLOUDFLEET_DOMAIN')}}
      WEB_DOMAIN: mastodon.{{'myblimp.net' | env('CLOUDFLEET_DOMAIN')}}
      # ALTERNATE_DOMAINS: example1.com,example2.com  FIXME create wy to deal with additional domains
      SMTP_FROM_ADDRESS: mastodon@{{'myblimp.net' | env('CLOUDFLEET_DOMAIN')}}
    labels:
      - "traefik.docker.network=blimp_network"
      - "traefik.enable=true"
      - "traefik.frontend.rule=Host:mastodon.{{'myblimp.net' | env('CLOUDFLEET_DOMAIN')}};Path:/"
      - "traefik.port=3000"
      - "traefik.protocol=http"


  streaming:
    image: cloudfleet/blimp-mastodon
    restart: always
    env_file: .env.production
    command: yarn start
    networks:
      - external_network
      - internal_network
    ports:
      - "127.0.0.1:4000:4000"
    depends_on:
      - mastodonpostgres
      - mastodonredis
    labels:
      - "traefik.docker.network=blimp_network"
      - "traefik.enable=true"
      - "traefik.frontend.rule=Host:mastodon.{{'myblimp.net' | env('CLOUDFLEET_DOMAIN')}};Path:/api/v1/streaming"
      - "traefik.port=4000"
      - "traefik.protocol=http"

  sidekiq:
    image: cloudfleet/blimp-mastodon
    restart: always
    command: bundle exec sidekiq
    depends_on:
      - mastodonpostgres
      - mastodonredis
    networks:
      - external_network
      - internal_network
    volumes:
      - /opt/cloudfleet/data/apps/mastodon/mastodon:/mastodon/public/system

  escapepod:
    hostname: escapepod
    image: "{{'registry.marina.io' | env('CLOUDFLEET_REGISTRY')}}/cloudfleet/blimp-escapepod:{{'latest' | env('CLOUDFLEET_STAGE')}}"

  traefik:
    hostname: traefik
    container_name: traefik
    image: "{{'registry.marina.io' | env('CLOUDFLEET_REGISTRY')}}/cloudfleet/blimp-traefik:{{'latest' | env('CLOUDFLEET_STAGE')}}"
    volumes:
      - "/opt/cloudfleet/data/shared/tls:/opt/cloudfleet/conf/tls"
    restart: always
    ports:
      - 80:80
      - 443:443
    networks:
      - blimp_network
      - pagekite_network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /opt/cloudfleet/data/shared/tls:/acme.json

  pagekite:
    hostname: pagekite
    image: "{{'registry.marina.io' | env('CLOUDFLEET_REGISTRY')}}/cloudfleet/blimp-pagekite:{{'latest' | env('CLOUDFLEET_STAGE')}}"
    environment:
      CLOUDFLEET_DOMAIN: "{{'myblimp.net' | env('CLOUDFLEET_DOMAIN')}}"
      CLOUDFLEET_HOST: "{{'blimpyard.cloudfleet.io' | env('CLOUDFLEET_HOST')}}"
      CLOUDFLEET_SECRET: "{{'secret' | env('CLOUDFLEET_SECRET')}}"

networks:
  pagekite_network:
  blimp_network:
    internal: true
  mastodon:
    internal: true
